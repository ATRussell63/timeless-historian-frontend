name: Deploy Release
on:
  push:
    tags:
      - '[0-9]+.[0-9]+*'

jobs:

  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Only process main branch
      run: |
          BRANCH=$(git branch --contains ${{ github.sha }} | grep "main" || true)
          if [ -z "$BRANCH" ]; then
            echo "Tag is NOT on main â€” stopping workflow."
            exit 1
          fi

    - name: Log in to GHCR
      run: echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Build image
      run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/timeless-historian-frontend:${{ github.ref_name }}
          docker build -t $IMAGE -f app/Dockerfile \
            --build-arg PUBLIC_API_URL=${{ secrets.PUBLIC_API_URL }} \
            PUBLIC_CURRENT_LEAGUE=${{ secrets.PUBLIC_CURRENT_LEAGUE }} .

    - name: Push image
      run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/timeless-historian-frontend:${{ github.ref_name }}
          docker push $IMAGE

    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.8
      with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            IMAGE=ghcr.io/${{ github.repository_owner }}/myapp:${{ github.ref_name }}
            echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull $IMAGE
            docker stop timeless-historian-frontend || true
            docker rm timeless-historian-frontend || true
            docker run -d --restart unless-stopped --name timeless-historian-frontend -e CLIENT_SECRET=${{ secrets.CLIENT_SECRET }} -p 3000:3000 $IMAGE
